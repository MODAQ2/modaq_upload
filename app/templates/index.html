{% extends "base.html" %}
{% from "macros.html" import spinner, stat_card %}

{% block title %}Upload Files - {{ super() }}{% endblock %}

{% block body_attrs %}data-page="upload"{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Upload MCAP Files</h1>
            <p class="text-gray-600 mt-1">Select a folder to upload MCAP files to MODAQ Cloud (NLR AWS S3)</p>
        </div>
    </div>

    <!-- Upload Steps Indicator -->
    <div id="upload-steps">
        <div class="bg-white rounded-lg shadow px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Step 1: Select -->
                <div class="flex items-center cursor-pointer hover:opacity-80" data-step="1" data-action="go-to-step" title="Go back to file selection">
                    <div class="step-circle flex items-center justify-center w-8 h-8 rounded-full border-2 border-gray-300 bg-white text-gray-500 font-semibold text-sm">
                        1
                    </div>
                    <span class="step-label ml-2 text-sm font-medium text-gray-500">Select</span>
                </div>

                <!-- Connector -->
                <div class="step-connector flex-1 h-0.5 bg-gray-300 mx-3"></div>

                <!-- Step 2: Review -->
                <div class="flex items-center" data-step="2">
                    <div class="step-circle flex items-center justify-center w-8 h-8 rounded-full border-2 border-gray-300 bg-white text-gray-500 font-semibold text-sm">
                        2
                    </div>
                    <span class="step-label ml-2 text-sm font-medium text-gray-500">Review</span>
                </div>

                <!-- Connector -->
                <div class="step-connector flex-1 h-0.5 bg-gray-300 mx-3"></div>

                <!-- Step 3: Upload -->
                <div class="flex items-center" data-step="3">
                    <div class="step-circle flex items-center justify-center w-8 h-8 rounded-full border-2 border-gray-300 bg-white text-gray-500 font-semibold text-sm">
                        3
                    </div>
                    <span class="step-label ml-2 text-sm font-medium text-gray-500">Upload</span>
                </div>

                <!-- Connector -->
                <div class="step-connector flex-1 h-0.5 bg-gray-300 mx-3"></div>

                <!-- Step 4: Complete -->
                <div class="flex items-center" data-step="4">
                    <div class="step-circle flex items-center justify-center w-8 h-8 rounded-full border-2 border-gray-300 bg-white text-gray-500 font-semibold text-sm">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <span class="step-label ml-2 text-sm font-medium text-gray-500">Complete</span>
                </div>
            </div>

            <!-- Step Description -->
            <div id="step-description" class="mt-3 text-center text-sm text-gray-600">
                Select files or a folder to upload
            </div>
        </div>
    </div>

    <!-- Inline Folder Browser -->
    <div id="folder-browser-panel" class="bg-white rounded-lg shadow overflow-hidden">
        <!-- Quick Links -->
        <div id="folder-quick-links" class="px-6 py-2 bg-gray-50 border-b border-gray-200 flex items-center space-x-2 overflow-x-auto">
            <!-- Quick links will be inserted here -->
        </div>

        <!-- Breadcrumb Navigation -->
        <div class="px-6 py-2 bg-gray-50 border-b border-gray-200">
            <div id="folder-breadcrumb" class="flex items-center space-x-1 text-sm overflow-x-auto">
                <!-- Breadcrumbs will be inserted here -->
            </div>
        </div>

        <!-- Current Path Info -->
        <div class="px-6 py-2 bg-blue-50 border-b border-gray-200 flex items-center justify-between">
            <span class="text-sm text-blue-800" title="Does not include files in subfolders">
                <span id="folder-mcap-count">0</span> MCAP files in this folder (not subfolders)
                <span id="browser-root-upload-status" class="ml-2"></span>
            </span>
        </div>

        <!-- Browser Scan Status Bar -->
        <div id="browser-scan-status" class="hidden px-6 py-2 bg-green-50 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <svg id="browser-scan-spinner" class="animate-spin h-4 w-4 text-nlr-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="browser-scan-text" class="text-sm text-gray-700">
                        Scanning folders...
                    </span>
                </div>
                <label class="flex items-center">
                    <input type="checkbox" id="browser-hide-uploaded"
                           class="rounded border-gray-300 text-nlr-blue focus:ring-nlr-blue">
                    <span class="ml-2 text-sm text-gray-600">Hide uploaded folders</span>
                </label>
            </div>
        </div>

        <!-- Folder List (subfolders) -->
        <div id="folder-list" class="divide-y divide-gray-200">
            <!-- Folders will be inserted here -->
        </div>

        <!-- File Table (MCAP files with sortable columns) -->
        <div id="file-table-section" class="hidden">
            <table class="w-full divide-y divide-gray-200">
                <thead class="bg-gray-50" id="file-table-head">
                    <tr>
                        <th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                            data-file-sort="name">
                            Filename <span class="file-sort-indicator"></span>
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 w-40"
                            data-file-sort="mtime">
                            Date Modified <span class="file-sort-indicator"></span>
                        </th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 w-24"
                            data-file-sort="size">
                            Size <span class="file-sort-indicator"></span>
                        </th>
                    </tr>
                </thead>
                <tbody id="file-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- File rows will be inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Loading State -->
        <div id="folder-loading" class="hidden p-8 text-center">
            {{ spinner() }}
        </div>

        <!-- Error State -->
        <div id="folder-error" class="hidden p-8 text-center">
            <p class="text-red-600" id="folder-error-message">Error loading folder</p>
        </div>

        <!-- Primary Upload Folder Action (sticky so it's visible with large file lists) -->
        <div class="px-6 py-4 border-t border-gray-200 bg-white sticky bottom-0 flex items-center justify-between">
            <span id="folder-select-summary" class="text-sm text-gray-600">
                Navigate to the folder containing your MCAP files, then click Upload Folder.
            </span>
            <button id="select-folder-btn"
                    class="px-8 py-3 bg-nlr-blue text-white text-base font-semibold rounded-lg shadow-md hover:bg-nlr-blue-light transition-colors disabled:bg-gray-300 disabled:text-gray-500 disabled:shadow-none disabled:cursor-not-allowed flex items-center">
                <span>Upload This Folder</span>
                <svg class="w-5 h-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Scan Results (Step 2: Review) -->
    <div id="scan-results-section" class="hidden">
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Review Selected Files</h2>
                <p class="text-sm text-gray-500 mt-1" id="selected-folder-path"></p>
            </div>

            <div class="p-6 border-b border-gray-200">
                <div class="grid grid-cols-3 gap-4 text-center mb-6">
                    {{ stat_card("scan-total", "Total MCAP Files", "gray") }}
                    {{ stat_card("scan-total-volume", "Total Volume", "blue", "0 B") }}
                    {{ stat_card("scan-already-uploaded", "Already Uploaded", "yellow") }}
                </div>

                <!-- Scan Progress Indicator -->
                <div id="scan-progress-container" class="hidden mb-4">
                    <div class="flex items-center space-x-3 px-4 py-3 bg-blue-50 rounded-lg">
                        <svg class="animate-spin h-5 w-5 text-nlr-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="scan-progress-text" class="text-sm text-blue-800">
                            Scanning folders...
                        </span>
                    </div>
                </div>

                <div class="flex justify-center space-x-4">
                    <button id="cancel-scan-btn"
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
                        </svg>
                        <span>Back</span>
                    </button>
                    <button id="continue-upload-btn"
                            class="px-6 py-2 bg-nlr-blue text-white rounded-md hover:bg-nlr-blue-light transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                        <span>Continue</span>
                        <svg class="w-4 h-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Sortable File Table -->
            <div class="px-6 py-3 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700">Files</span>
                <div class="flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="scan-hide-completed-folders"
                               class="rounded border-gray-300 text-nlr-blue focus:ring-nlr-blue">
                        <span class="ml-2 text-sm text-gray-600">Hide completed folders</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="scan-hide-uploaded"
                               class="rounded border-gray-300 text-nlr-blue focus:ring-nlr-blue">
                        <span class="ml-2 text-sm text-gray-600">Hide already uploaded</span>
                    </label>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full divide-y divide-gray-200 table-fixed">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="w-1/4 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="filename">
                                Filename <span class="sort-indicator"></span>
                            </th>
                            <th class="w-1/4 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="path">
                                Path <span class="sort-indicator"></span>
                            </th>
                            <th class="w-1/6 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="mtime">
                                Date Modified <span class="sort-indicator"></span>
                            </th>
                            <th class="w-20 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="size">
                                Size <span class="sort-indicator"></span>
                            </th>
                            <th class="w-24 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="status">
                                Status <span class="sort-indicator"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="scan-file-list" class="bg-white divide-y divide-gray-200">
                        <!-- File rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Combined Upload (Step 3: Validate + Upload) -->
    <div id="upload-section" class="hidden">
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Upload Progress</h2>
                <button id="cancel-upload-btn"
                        class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                    Cancel Upload
                </button>
            </div>

            <!-- Phase Label -->
            <div id="upload-phase" class="px-6 py-2 bg-blue-50 border-b border-gray-200">
                <span class="text-sm font-medium text-blue-800" id="upload-phase-label">Validating files...</span>
            </div>

            <!-- Overall Progress -->
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">
                        Overall Progress: <span id="progress-percent">0</span>%
                    </span>
                    <span class="text-sm text-gray-500">
                        <span id="files-completed">0</span> / <span id="files-total">0</span> files
                        (<span id="bytes-uploaded">0 B</span> / <span id="bytes-total">0 B</span>)
                    </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="progress-bar" class="progress-bar bg-nlr-blue h-4 rounded-full" style="width: 0%"></div>
                </div>
                <div class="mt-2 text-sm text-gray-500">
                    ETA: <span id="eta">Calculating...</span>
                </div>
            </div>

            <!-- File Status List -->
            <div id="upload-file-list" class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
                <!-- File progress items will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Completion Summary (Step 4: Complete) -->
    <div id="completion-section" class="hidden">
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Upload Summary</h2>
            </div>

            <div class="p-6">
                <!-- File Status Summary -->
                <div id="completion-summary" class="grid grid-cols-3 gap-6 text-center mb-6">
                    {{ stat_card("completed-count", "Uploaded", "green", size="3xl") }}
                    {{ stat_card("skipped-count", "Skipped", "yellow", size="3xl") }}
                    {{ stat_card("failed-count", "Failed", "red", size="3xl") }}
                </div>

                <!-- Aggregate Stats -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div id="total-uploaded-size" class="text-xl font-bold text-gray-800">-</div>
                            <div class="text-xs text-gray-500">Data Uploaded</div>
                        </div>
                        <div>
                            <div id="total-upload-time" class="text-xl font-bold text-gray-800">-</div>
                            <div class="text-xs text-gray-500">Total Time</div>
                        </div>
                        <div>
                            <div id="avg-upload-speed" class="text-xl font-bold text-gray-800">-</div>
                            <div class="text-xs text-gray-500">Avg Speed</div>
                        </div>
                        <div>
                            <div id="avg-file-time" class="text-xl font-bold text-gray-800">-</div>
                            <div class="text-xs text-gray-500">Avg per File</div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-center space-x-4 mb-6">
                    <button id="upload-more-btn"
                            class="px-6 py-2 bg-nlr-blue text-white rounded-md hover:bg-nlr-blue-light transition-colors">
                        Upload More Files
                    </button>
                    <button id="download-csv-btn"
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Download CSV
                    </button>
                    <a href="{{ url_for('main.files') }}"
                       class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                        Browse Uploaded Files
                    </a>
                </div>
            </div>

            <!-- File Details Table -->
            <div class="border-t border-gray-200">
                <div class="px-6 py-3 bg-gray-50 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-700">File Details</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">File</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">S3 Path</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duration</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Speed</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="completion-file-list" class="bg-white divide-y divide-gray-200">
                            <!-- File rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Upload Modal -->
<div id="confirm-upload-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="fixed inset-0 bg-black bg-opacity-50" data-action="close-confirm-modal"></div>
    <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Upload to MODAQ Cloud?</h3>
        <p class="text-sm text-gray-600 mb-2">
            <span id="confirm-file-count" class="font-medium">0</span> files
            (<span id="confirm-total-size" class="font-medium">0 B</span>) will be uploaded.
        </p>
        <label class="flex items-center mb-2">
            <input type="checkbox" id="force-reupload-checkbox"
                   class="rounded border-gray-300 text-nlr-blue focus:ring-nlr-blue">
            <span class="ml-2 text-sm text-gray-700">Force reupload already uploaded files</span>
        </label>
        <p id="confirm-skip-note" class="text-xs text-gray-500 mb-6">
            Duplicate files will be automatically skipped.
        </p>
        <div class="flex justify-end space-x-3">
            <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"
                    data-action="close-confirm-modal">
                Cancel
            </button>
            <button id="confirm-upload-btn"
                    class="px-4 py-2 bg-nlr-green text-white rounded-md hover:bg-nlr-green-light transition-colors">
                Confirm Upload
            </button>
        </div>
    </div>
</div>
{% endblock %}
